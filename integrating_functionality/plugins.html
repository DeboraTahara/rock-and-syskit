<!DOCTYPE html>
<html lang="en">
    <head>
        <meta content="IE=edge" http-equiv="X-UA-Compatible">
        <meta charset="utf-8">
        <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Robot Construction Toolkit</title>

        <link href="../images/favicon.ico" rel="icon" type="image/ico" relative="true" />
        <link href="../stylesheets/site.css" rel="stylesheet" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    </head>

    <body class="integrating_functionality integrating_functionality_plugins">
            <!-- top navbar -->
    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav">
                    <li><a href="../">Home</a></li>
                    <li><a href="../about.html">About</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3" role="complementary">
                <nav class="docs-sidebar" data-spy="affix">
                    <ul class="nav"><li class='child'><a href="../">Building robots with Rock and Syskit</a></li><li class='parent'><span class='parent-label'><a href="../basics/">Basics</a></span><ul><li class='child'><a href="../basics/">Introduction</a></li><li class='child'><a href="../basics/installation.html">Installation</a></li><li class='child'><a href="../basics/day_to_day.html">Day-to-day Workspace Commands</a></li><li class='child'><a href="../basics/getting_started.html">Getting Started</a></li><li class='child'><a href="../basics/composition.html">Compositions</a></li><li class='child'><a href="../basics/constant_generator.html">Constant Generator</a></li><li class='child'><a href="../basics/devices.html">Devices</a></li><li class='child'><a href="../basics/deployment.html">Deployment</a></li><li class='child'><a href="../basics/validation.html">Configuration Consistency</a></li><li class='child'><a href="../basics/recap.html">Recap</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../runtime_overview/">Runtime Overview</a></span><ul><li class='child'><a href="../runtime_overview/">Introduction</a></li><li class='child'><a href="../runtime_overview/task_structure.html">Task Structures</a></li><li class='child'><a href="../runtime_overview/event_loop.html">Event Loop</a></li><li class='child'><a href="../runtime_overview/exceptions.html">Errors</a></li><li class='child'><a href="../runtime_overview/live_data.html">Live Data Visualization</a></li><li class='child'><a href="../runtime_overview/recap.html">Recap</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../workspace/">Workspace and Packages</a></span><ul><li class='child'><a href="../workspace/">Introduction</a></li><li class='child'><a href="../workspace/conventions.html">Conventions</a></li><li class='child'><a href="../workspace/setup.html">Starting a New Project</a></li><li class='child'><a href="../workspace/add_packages.html">Adding new packages</a></li><li class='child'><a href="../workspace/os_dependencies.html">OS Dependencies</a></li><li class='child'><a href="../workspace/managing.html">Build configuration design</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../type_system/">The Type System</a></span><ul><li class='child'><a href="../type_system/">Introduction</a></li><li class='child'><a href="../type_system/defining_types.html">Defining Types</a></li><li class='child'><a href="../type_system/types_in_ruby.html">Types in Ruby</a></li></ul></li><li class='parent active'><span class='parent-label'><a href="./">Integrating Functionality</a></span><ul><li class='child'><a href="./">Introduction</a></li><li class='child'><a href="cpp_libraries.html">C++ Library Packages</a></li><li class='child'><a href="ruby_libraries.html">Ruby Library Packages</a></li><li class='child'><a href="components.html">Components</a></li><li class='child'><a href="interface.html">Interface</a></li><li class='child'><a href="state_machine.html">State Machine</a></li><li class='child'><a href="writing_the_hooks.html">Writing the Hooks</a></li><li class='child'><a href="deployment.html">Deployments</a></li><li class='child active'><a href="plugins.html">Extending oroGen</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../syskit_coordination/">Coordination</a></span><ul><li class='child'><a href="../syskit_coordination/">Introduction</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../syskit_error_handling/">Error Handling</a></span><ul><li class='child'><a href="../syskit_error_handling/">Introduction</a></li></ul></li></ul>
                </nav>
            </div>
            <div class="col-md-9" role="main">
                <h1 class="no_toc" id="extending-orogen">Extending oroGen</h1>

<ul id="markdown-toc">
  <li><a href="#general-principle" id="markdown-toc-general-principle">General principle</a></li>
  <li><a href="#adding-methods-to-task-contexts" id="markdown-toc-adding-methods-to-task-contexts">Adding methods to task contexts</a></li>
  <li><a href="#adding-attributes-to-the-base-class" id="markdown-toc-adding-attributes-to-the-base-class">Adding attributes to the base class</a></li>
  <li><a href="#adding-code-to-the-base-class-constructor-and-destructor" id="markdown-toc-adding-code-to-the-base-class-constructor-and-destructor">Adding code to the base class constructor and destructor</a></li>
  <li><a href="#adding-code-the-hooks-in-the-base-class" id="markdown-toc-adding-code-the-hooks-in-the-base-class">Adding code the hooks in the base class</a></li>
  <li><a href="#adding-code-at-the-toplevel" id="markdown-toc-adding-code-at-the-toplevel">Adding code at the toplevel</a></li>
  <li><a href="#code-generation-hooks" id="markdown-toc-code-generation-hooks">Code Generation Hooks</a></li>
  <li><a href="#adding-user-defined-classes-to-generation" id="markdown-toc-adding-user-defined-classes-to-generation">Adding user-defined classes to generation</a></li>
</ul>

<p>oroGen plugins offer ways to add new statements to the oroGen specification
file, allowing to integrate some libraries in the component development
workflow. Two examples are the <a href="TODO">stream aligner</a> and the
<a href="TODO">transformer</a>.</p>

<h2 id="general-principle">General principle</h2>

<p>The general plugin design is based on the extensible nature of the Ruby
language. How the plugin loading works is:</p>

<ul>
  <li>the OROGEN_PLUGIN_PATH environment variable contains directories in which
plugin files (actually, ruby files) are.</li>
  <li>these ruby files get loaded by oroGen at startup through the normal "require"
mechanism</li>
  <li>the code in the Ruby file should extend the task context's class
(<code>OroGen::Spec::TaskContext</code>) to add new functionality. Examples can be found
at the bottom of this page.</li>
</ul>

<p>Example of a very simple plugin:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">BoolPlugin</span> <span class="o">&lt;</span>  <span class="no">OroGen</span><span class="o">::</span><span class="no">Spec</span><span class="o">::</span><span class="no">TaskModelExtension</span>
    <span class="nb">attr_accessor</span> <span class="ss">:varname</span>

    <span class="c1"># implement extension for task</span>
    <span class="k">def</span> <span class="nf">pre_generation_hook</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="n">task</span><span class="p">.</span><span class="nf">add_base_member</span><span class="p">(</span><span class="s2">"simple_plugin"</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="s2">"bool"</span><span class="p">)</span>
        <span class="n">task</span><span class="p">.</span><span class="nf">operations</span><span class="p">[</span><span class="s2">"getBool"</span><span class="p">].</span>
            <span class="nf">base_body</span><span class="p">(</span><span class="s2">"return </span><span class="si">#{</span><span class="n">varname</span><span class="si">}</span><span class="s2">;"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">OroGen</span><span class="o">::</span><span class="no">Spec</span><span class="o">::</span><span class="no">TaskContext</span>
    <span class="k">def</span> <span class="nf">add_boolean_attribute</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>
        <span class="n">extension_name</span> <span class="o">=</span> <span class="s2">"BoolPlugin"</span>
        <span class="c1"># find previous instance of the extension</span>
        <span class="n">extension</span> <span class="o">=</span> <span class="n">find_extension</span><span class="p">(</span><span class="n">extension_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">extension</span>
            <span class="c1"># create new instance</span>
            <span class="n">boolp</span> <span class="o">=</span> <span class="no">BoolPlugin</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">extension_name</span><span class="p">)</span>
            <span class="n">boolp</span><span class="p">.</span><span class="nf">varname</span> <span class="o">=</span> <span class="n">varname</span>
            <span class="c1"># define interface for task</span>
            <span class="n">hidden_operation</span><span class="p">(</span><span class="s2">"getBool"</span><span class="p">).</span>
                <span class="nf">returns</span><span class="p">(</span><span class="s2">"bool"</span><span class="p">)</span>
            <span class="n">register_extension</span><span class="p">(</span><span class="n">boolp</span><span class="p">)</span>
        <span class="k">else</span>
            <span class="k">raise</span> <span class="no">OroGen</span><span class="o">::</span><span class="no">ConfigError</span><span class="p">,</span> <span class="s2">"Plugin '</span><span class="si">#{</span><span class="n">extension_name</span><span class="si">}</span><span class="s2">' is already instantiated with base member '</span><span class="si">#{</span><span class="n">extension</span><span class="p">.</span><span class="nf">varname</span><span class="si">}</span><span class="s2">'. '</span><span class="si">#{</span><span class="n">varname</span><span class="si">}</span><span class="s2">' will not be created."</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>If this plugin is present, the <code>add_boolean_attribute</code> method becomes available on
task context definitions. Then, the generated Base class for these tasks will
include a boolean attribute with the name given as parameter. Below, it would be
"test".</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">task_context</span> <span class="s2">"Task"</span> <span class="k">do</span>
    <span class="n">add_boolean_attribute</span> <span class="s2">"test"</span>
<span class="k">end</span>
</code></pre></div>
<p>Edit <code>.orogen/tasks/TaskBase.hpp</code> to see the new attribute.</p>

<h2 id="adding-methods-to-task-contexts">Adding methods to task contexts</h2>

<p>The add_base_method and add_user_method methods allow to add virtual methods to
(respectively) the user-visible part of a task context and the Base class of the
task context.</p>

<p>The syntax (simply replace add_base_method by add_user_method to have the same
behaviour on the user-part of the task class)</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">add_base_method</span><span class="p">(</span><span class="n">return_type</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span>
</code></pre></div>
<p>This method call declares a pure virtual method (no body has been specified
yet). To give a body, one has to call #body on the value returned by
add_base_method:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">add_base_method</span><span class="p">(</span><span class="n">return_type</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">signature</span><span class="p">).</span>
    <span class="nf">body</span><span class="p">(</span><span class="n">body_of_the_method</span><span class="p">)</span>
</code></pre></div>
<p>Where the body is the method's implementation without the toplevel block markers</p>

<p>For instance, oroGen adds a getModelName method to every task context. It is defined
by</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">add_base_method</span><span class="p">(</span><span class="s2">"std::string"</span><span class="p">,</span> <span class="s2">"getModelName"</span><span class="p">,</span> <span class="s2">""</span><span class="p">).</span>
    <span class="nf">body</span><span class="p">(</span><span class="s2">"return </span><span class="se">\"</span><span class="si">#{</span><span class="n">task_model</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="se">\"</span><span class="s2">;"</span><span class="p">)</span>
</code></pre></div>
<h2 id="adding-attributes-to-the-base-class">Adding attributes to the base class</h2>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">add_base_member</span><span class="p">(</span><span class="s2">"kind"</span><span class="p">,</span> <span class="s2">"attribute_name"</span><span class="p">,</span> <span class="s2">"attribute_type"</span><span class="p">)</span>
</code></pre></div>
<p>Additionally, related code can be added to the initializer list, constructor
and/or destructor:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">add_base_member</span><span class="p">(</span><span class="s2">"kind"</span><span class="p">,</span> <span class="s2">"attribute_name"</span><span class="p">,</span> <span class="s2">"attribute_type"</span><span class="p">).</span>
    <span class="nf">initializer</span><span class="p">(</span><span class="s2">"code_in_initializer_list"</span><span class="p">).</span>
    <span class="nf">constructor</span><span class="p">(</span><span class="s2">"code_in_constructor"</span><span class="p">).</span>
    <span class="nf">destructor</span><span class="p">(</span><span class="s2">"code_in_destructor"</span><span class="p">)</span>
</code></pre></div>
<p><code>kind</code> is a simple string that is only used for sorting the declarations. For
instance the properties use "properties" as "kind" so that all properties get
grouped together.</p>

<h2 id="adding-code-to-the-base-class-constructor-and-destructor">Adding code to the base class constructor and destructor</h2>

<p>It is simply done with:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">add_base_construction</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
<span class="n">add_base_destruction</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
</code></pre></div>
<p>+kind+ and +name+ will have no meaning. They will only be used for sorting the
code snippets, so that the generated code always stays the same (avoiding
unnecessary recompilations).</p>

<h2 id="adding-code-the-hooks-in-the-base-class">Adding code the hooks in the base class</h2>

<p>It is done with</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">in_base_hook</span><span class="p">(</span><span class="n">hook_name</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
</code></pre></div>
<p>For instance, oroGen clears all input ports in the base <code>startHook</code> with</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">each_input_port</span> <span class="k">do</span> <span class="o">|</span><span class="n">port</span><span class="o">|</span>
    <span class="n">in_base_hook</span><span class="p">(</span><span class="s1">'start'</span><span class="p">,</span> <span class="s2">"_</span><span class="si">#{</span><span class="n">port</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2">.clear();"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<h2 id="adding-code-at-the-toplevel">Adding code at the toplevel</h2>

<p>Code can be added at the toplevel of the Base.hpp and Base.cpp files. Simply do</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">add_base_header_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">include_before</span><span class="p">)</span>
</code></pre></div>
<p>Where include_before should be true if the code needs to be added before the
Base class declaration and false if it should be after.</p>

<p>and</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">add_base_implementation_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">include_before</span><span class="p">)</span>
</code></pre></div>
<h2 id="code-generation-hooks">Code Generation Hooks</h2>

<p>There are three different hook available which plugins could use.  The above
listed <code>pre_generation_hook</code> makes it able to add code to existing base-methods
or register new base methods for generation.</p>

<p>The <code>generation_hook</code> is the normal use-case for plugins. In this generation
step regular ports or methods can be created, but no new code can be added to
existing base-members.</p>

<p>The <code>post_generation_hook</code> is only intended to read the finally generated
task-context.  No modifications on the TaskContext or the generation should be
done at this step. This hook is useful to extract information during
compilation time.</p>

<h2 id="adding-user-defined-classes-to-generation">Adding user-defined classes to generation</h2>

<p>Plugins that want to register additional classes during compilation
can register a subfolder within the CMake build system. These subfolders get 
added to the compilation unit. The plugin developer has to make sure that the folder
and a CMakeLists.txt within it has been generated during one of the above listed hooks.
If this classes should be installed or linked against other parts, regular CMake commands must
be used. The subfolders names must be export as a enumerable of string by the 
<code>each_auto_gen_source_directory</code> method of the plugin, example:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">each_auto_gen_source_directory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="p">[</span><span class="s1">'src1'</span><span class="p">,</span><span class="s1">'src2'</span><span class="p">].</span><span class="nf">each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p><strong>Next</strong> That's all, folks. Go back to <a href="../#how_to_read">the list of topics</a></p>

            </div>
        </div>
    </div>

    <script>
    $('.docs-sidebar').affix({
        offset: {
            top: $('.docs-sidebar').offset().top
        }
    });
    </script>


        <footer class="container-fluid text-center">
            <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/InteractiveResource" property="dct:title" rel="dct:type">Building Robots with Rock and Syskit</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/doudou" property="cc:attributionName" rel="cc:attributionURL">Sylvain Joyeux</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>. Copyright Sylvain Joyeux and Contributors
        </footer>
    </body>
</html>
