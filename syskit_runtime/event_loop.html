<!DOCTYPE html>
<html lang="en">
    <head>
        <meta content="IE=edge" http-equiv="X-UA-Compatible">
        <meta charset="utf-8">
        <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Robot Construction Toolkit</title>

        <link href="../images/favicon.ico" rel="icon" type="image/ico" relative="true" />
        <link href="../stylesheets/site.css" rel="stylesheet" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    </head>

    <body class="syskit_runtime syskit_runtime_event_loop">
            <!-- top navbar -->
    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav">
                    <li><a href="../">Home</a></li>
                    <li><a href="../about.html">About</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3" role="complementary">
                <nav class="docs-sidebar" data-spy="affix">
                    <ul class="nav"><li class='child'><a href="../">Building robots with Rock and Syskit</a></li><li class='parent'><span class='parent-label'><a href="../workspace/">The Workspace</a></span><ul><li class='child'><a href="../workspace/">Introduction</a></li><li class='child'><a href="../workspace/day_to_day.html">Day-to-day</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../syskit_basics/">Basics</a></span><ul><li class='child'><a href="../syskit_basics/">Introduction</a></li><li class='child'><a href="../syskit_basics/getting_started.html">Getting Started</a></li><li class='child'><a href="../syskit_basics/composition.html">Compositions</a></li><li class='child'><a href="../syskit_basics/constant_generator.html">Constant Generator</a></li><li class='child'><a href="../syskit_basics/devices.html">Devices</a></li><li class='child'><a href="../syskit_basics/deployment.html">Deployment</a></li><li class='child'><a href="../syskit_basics/recap.html">Recap</a></li></ul></li><li class='parent active'><span class='parent-label'><a href="./">Runtime</a></span><ul><li class='child'><a href="./">Introduction</a></li><li class='child'><a href="task_structure.html">Task Structures</a></li><li class='child active'><a href="event_loop.html">Event Loop</a></li><li class='child'><a href="exceptions.html">Exceptions</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../syskit_coordination/">Coordination</a></span><ul><li class='child'><a href="../syskit_coordination/">Introduction</a></li></ul></li></ul>
                </nav>
            </div>
            <div class="col-md-9" role="main">
                <h1 id="syskits-event-loop">Syskit's event loop</h1>

<p>This page will be the first one that will go deeper in Syskit's execution
model. This one will present Syskit's event loop structure, detailing how
things like configuring, starting or stopping components is sequenced
during Syskit's execution.</p>

<h2 id="events-reactor-synchronous-and-asynchronous">Events, Reactor, Synchronous and Asynchronous</h2>

<p>Fundamentally, Syskit's execution is event-based and based on the reactor
pattern. External events are received and Syskit does "other things" in
reaction to their happening. Most common reaction is to call a piece of code
registered as a <em>handler</em> for the event. Schematically:</p>

<p>TODO: event reactor figures</p>

<p>Unlike common event-based programming environments, Syskit does not only
<em>react</em> to events, but can also <em>cause</em> them. Some events, such as the start
and stop events of components are <em>controllable</em>, which means that Syskit can
make them happen instead of only waiting for them to happen, by calling a piece
of code called the <em>event command</em>.</p>

<p>Within Syskit, events are <em>propagated</em>. This means that Syskit tries to
maintain a synchronous model in which within the same propagation, events can
cause the emission of other events (within for instance an event handler). The
new events are then propagated which …. For instance, compositions do not have
to do anything to "be started". Therefore, the <em>start</em> event is emitted at the
moment it is called. This propagation is <strong>synchronous</strong>, the whole propagation
is done within a single event cycle.</p>

<p>This event propagation is done <strong>within a single thread</strong>. Which means that
computation within event commands and handlers will block the propagation. To
avoid issues with e.g. blocking network calls, Syskit has infrastructure to
execute remote calls <strong>asynchronously</strong>. The event command executes in a
separate (blocking) thread and the event emission is delayed until that command
finishes, possibly in a new event cycle.</p>

<h2 id="scheduling">Scheduling</h2>

<p>The scheduler is an object responsible to determine which <em>start</em> commands can
be executed at the beginning of a given cycle, and to execute them. Syskit's
default scheduler is the temporal scheduler. We will see some characteristic of
this scheduler in this section.</p>

<p>First and foremost, a component can be scheduled only if:</p>

<ul>
  <li>
    <p>it has all its parameters set. This is a common problem, that some arguments
are unset and the network does not run. This can be caught <a href="../syskit_basics/constant_generator.html#missing_arguments">in
tests</a>. At
runtime, in the IDE, this is leads to the following message:</p>

    <p>TODO: missing argument in IDE</p>
  </li>
  <li>
    <p>its <a href="task_structure.html#execution_agents">execution agent</a> is ready. Agents
are expected to have a <em>ready</em> event that is emitted when the agent reached a
state where the components it supports can be executed.</p>
  </li>
</ul>

<p>In addition, the basic scheduling rules are:</p>

<ul>
  <li>a component may be started only if at least one of its parents <a href="task_structure.html#dependency">in the
dependency relation</a> is running (the <em>start</em>
event has been emitted).</li>
  <li>a component may be started only if all its inputs are connected</li>
</ul>

<p>To illustrate this, let's have a step-by-step look at the startup of the safe
pose job. Try to notice where the cycle boundaries happen.</p>

<p>TODO: step-by-step of safe pose.</p>

<p class="callout callout-warning">Under these rules, the semantic of "a component is running" is to represent
that the system has  the <em>intent</em> to achieve its role, but not that it actually
does execute that role (yet): the component's children may not run yet. For
instance, a running safe position composition represents that the system has
the intent to reach that position, but it will not be reaching that position
until the composition's constant generator and arm model are running. This will
be an important distinction when building more complex, coordinated systems.</p>

<p class="callout callout-info">Note that this is a simplification that is "good enough" for now. These are
default rules, that can be overridden explicitly on a case-by-case basis. There
will be more about this in <a href="../syskit_coordination/">the coordination part</a>.</p>

<h2 id="component-lifecycle-configuration-startup-and-shutdown">Component Lifecycle, Configuration, Startup and Shutdown</h2>

<p>Rock components have a lifecycle of their own. This lifecyle is what makes a
generic coordination of them possible: one can expect a standardized behavior.</p>

<p>The lifecycle of a single component is a state machine that looks like this
(without error states represented):</p>

<p><img src="media/state_machine.svg" alt="Nominal component state machine" class="fullwidth" /></p>

<p>This is the lifecycle of a single component. Sequencing of the startup and
shutdown of a network is more complicated, and it relies on assumptions that
make it possible to determine when to connect, configure or start a component.</p>

<ol>
  <li>Component's <code>configure</code> transition is expected to mostly be standalone -
i.e. not rely on other components. The exception to this rule are devices
that rely on data bus components (e.g. a CAN device on a CAN bus).</li>
  <li>Components have the ability to create new ports dynamically, which is
usually controlled by their configuration. Syskit may therefore not expect
all ports to be available before the component is configured. Syskit
restricts dynamic port creation to <code>configure</code>, and their destruction to
<code>cleanup</code>.</li>
</ol>

<p>With these assumptions, Syskit can generically sequence the startup and
shutdown of a component network:</p>

<p>TODO: component network sequencing</p>

<p>All actions that involve a direct interaction with the component (sending the
start command, writing properties, …) are done asynchronously in separate
threads, and will be done in parallel if more than one component are being
setup. All actions that involve code written within the Syskit app itself are
executed sequentially within the main thread.</p>

<h2 id="garbage-collection">Garbage Collection</h2>

<p>The garbage collection recursively stops tasks that are not useful for an
active job, as in the following video. Note again the event cycle boundaries,
and how they mark a difference between synchronous stops (compositions) and
asynchronous ones (external components):</p>

<p>TODO: video step by step garbage collection</p>

<h2 id="component-reconfiguration">Component Reconfiguration</h2>

<p>As <a href="task_structure.html#usefulness">already mentioned</a>, external processes are
marked as permanent by default within Syskit. One of the main reasons is that
configuration of an external component may be fairly expensive (load maps,
precompute expensive data structures, configure a device, …), and Syskit
therefore attempts to reduce how often they are required.</p>

<p>When configuring components, Syskit will attempt to <code>cleanup</code> and <code>configure</code> a
given component only if the component's configuration changed since the last
configuration. Otherwise, it will only have to start it. <code>cleanup</code> is also done
asynchronously to avoid blocking the main thread execution.</p>

<p>In the following video, we change the configuration file for our cartesian
controller, reload the configuration and trigger a redeploy. We then see how
this triggers a reconfiguration:</p>

<p>TODO: video change configuration</p>

<p>Another source of reconfiguration is to transition between two networks that
select different component configurations. Let's create two controller
configurations in <code>config/orogen/cart_ctrl_wdls::WDLSSolver.yml</code>:</p>

<div class="highlight"><pre class="highlight yaml"><code></code></pre></div>
<p>and two networks using these two different configurations in
<code>models/profiles/gazebo/arm_control.rb</code>:</p>

<div class="highlight"><pre class="highlight plaintext"><code></code></pre></div>
<p>We can then transition between the two and see the component be reconfigured:</p>

<p>TODO: video</p>

<p>We've seen so far how things work <em>nominally</em>. Let's see <a href="exceptions.html" class="btn btn-primary">how Syskit reacts when
things go wrong</a>.</p>

            </div>
        </div>
    </div>

    <script>
    $('.docs-sidebar').affix({
        offset: {
            top: $('.docs-sidebar').offset().top
        }
    });
    </script>


        <footer class="container-fluid text-center">
        </footer>
    </body>
</html>
