<!DOCTYPE html>
<html lang="en">
    <head>
        <meta content="IE=edge" http-equiv="X-UA-Compatible">
        <meta charset="utf-8">
        <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Robot Construction Toolkit</title>

        <link href="../images/favicon.ico" rel="icon" type="image/ico" relative="true" />
        <link href="../stylesheets/site.css" rel="stylesheet" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <style>
          /* Remove the navbar's default margin-bottom and rounded borders */
          .navbar {
              margin-bottom: 0;
              border-radius: 0;

          }

          /* Set height of the grid so .sidenav can be 100% (adjust as needed) */
          .row.content {height: 450px}

          /* Set gray background color and 100% height */
          .sidenav {
              padding-top: 20px;
              background-color: #f1f1f1;
              height: 100%;
          }

          /* Set black background color, white text and some padding */
          footer {
              background-color: #000000;
              color: white;
              padding: 5px;
          }

          /* On small screens, set height to 'auto' for sidenav and grid */
          @media screen and (max-width: 767px) {
              .sidenav {
                  height: auto;
                  padding: 15px;
              }
              .row.content {height:auto;}
          }
        </style>
    </head>

    <body class="syskit_basics syskit_basics_getting_started">

            <!-- top navbar -->
    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav">
                    <li><a href="../">Home</a></li>
                    <li><a href="../about.html">About</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row content">
            <div class="col-sm-3 sidenav">
                <ul><li class='child '><a href="../">Building robots with Rock and Syskit</a></li><li class='parent '><span class='parent-label'><a href="../workspace/">The Workspace</a></span><ul><li class='child '><a href="../workspace/">Introduction</a></li><li class='child '><a href="../workspace/day_to_day.html">Day-to-day</a></li></ul></li><li class='parent '><span class='parent-label'><a href="./">Basics</a></span><ul><li class='child '><a href="./">Introduction</a></li><li class='child active'><a href="getting_started.html">Getting Started</a></li><li class='child '><a href="composition.html">Compositions</a></li><li class='child '><a href="constant_generator.html">Constant Generator</a></li><li class='child '><a href="devices.html">Devices</a></li><li class='child '><a href="deployment.html">Deployment</a></li><li class='child '><a href="recap.html">Recap</a></li></ul></li><li class='parent '><span class='parent-label'><a href="../transformations/">Transformations</a></span><ul><li class='child '><a href="../transformations/">Geometric Relations</a></li></ul></li></ul>
            </div>
            <div class="col-sm-7 text-left">
                <h1 id="getting-started">Getting Started</h1>

<p>We'll be getting right into the meat of things by creating a system's
integration package (a <code>bundle</code>), and setup a gazebo environment that will
allow us to continue with actually doing something with the system.</p>

<h2 id="bundles-and-bundles-file-structure">Bundles and bundles' file structure</h2>

<p>In Rock, the central place where the system design and integration happens is a
<em>bundle</em>. A bundle package is created in the <code>bundles/</code> folder of your Rock
workspace. For the time being, you can see bundles as a collection of
Syskit models (in <code>models/</code>), configuration files (in <code>config/</code>), SDF scenes
(<code>scenes/</code>) and SDF models (<code>models/sdf/</code>).</p>

<p>The following assumes that you have a <a href="../workspace/">bootstrapped Rock
installation</a>, and that you have a terminal in which this
installation's <code>env.sh</code> file has been sourced.</p>

<p>Let's create a new bundle. In your Rock's workspace do</p>

<pre class="highlight plaintext"><code>acd
cd bundles
roby init syskit_basics
cd syskit_basics
</code></pre>
<p>This creates a Roby application, Roby being the underlying application framework
and execution engine that Syskit is based on. To be able to use Syskit in this new
application, we must explicitly load it in <code>config/init.rb</code> by adding</p>

<pre class="highlight ruby"><code><span class="no">Roby</span><span class="p">.</span><span class="nf">app</span><span class="p">.</span><span class="nf">using</span> <span class="s1">'syskit'</span>
</code></pre>
<p>We can now verify that the generated application at loads with</p>

<pre class="highlight plaintext"><code>$ syskit run
Bundles[INFO]: Active bundles: syskit_basics
default[INFO]: logs are in /home/doudou/dev/logs_area/syskit_basics/20170609-1609
default[INFO]: loaded Roby on ruby 2.3.1p112 (2016-04-26 revision 54768) [x86_64-linux]
default[INFO]: done initialization
default[INFO]: ready
</code></pre>
<p>Either hit CTRL+C, or run <code>syskit quit</code> in another terminal, to make it exit.</p>

<pre class="highlight plaintext"><code>$ syskit quit
Bundles[INFO]: Active bundles: syskit_basics
default[INFO]: connected
default[INFO]: waiting for remote app to terminate
default[INFO]: closed communication
</code></pre>
<h2 id="robot-and-scene-description-using-sdf">Robot and Scene description using SDF</h2>

<p>The <a href="http://sdformat.org">Scene Description Format</a> is a XML format defined by the
Gazebo developers to describe both scenes and objects in these scenes (as e.g.
robots). We're going to learn how to leverage the information present in an SDF
file as possible, with the goal of having the SDF be the authoritative
information source for any information that can be represented in it.</p>

<p>But for now, let's get to create ourselves a scene with a robot in it. We
will <strong>not</strong> describe the SDF format in details, there's a lot of
Gazebo-related documentation about that, <a href="http://sdformat.org/spec">including a reference of the format
on sdformat.org</a></p>

<p>SDF scenes are made of <em>models</em>. Loosely-speaking, each model represents one
object in the scene. Moreover, models can be included in scenes through the
<code>&lt;include&gt;</code> tags, allowing to reuse models in different scenes. In general,
your robot should at least be described in a separate model to allow you to
reuse it in different simulation scenes.</p>

<p>For the purpose of this part of the documentation, we'll use Gazebo's UR10 arm
model as our robot. We however need to integrate it in another model so that
its base is fixed (using <a href="http://answers.gazebosim.org/question/5065/how-to-attach-arm-to-a-static-base-using-sdf/">this
method</a>) Models are saved in <code>models/sdf/</code>, let's create
<code>models/sdf/ur10_fixed</code> and create a Gazebo model description file <code>models/sdf/ur10_fixed/model.config</code> with</p>

<pre class="highlight xml"><code><span class="cp">&lt;?xml version="1.0"?&gt;</span>

<span class="nt">&lt;model&gt;</span>
  <span class="nt">&lt;name&gt;</span>Universal Robotics UR10 robot arm on a fixed base<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;sdf&gt;</span>model.sdf<span class="nt">&lt;/sdf&gt;</span>
<span class="nt">&lt;/model&gt;</span>
</code></pre>
<p>and the corresponding SDF model in <code>models/sdf/ur10_fixed/model.sdf</code></p>

<pre class="highlight xml"><code><span class="cp">&lt;?xml version='1.0'?&gt;</span>
<span class="nt">&lt;sdf</span> <span class="na">version=</span><span class="s">'1.5'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">"ur10_fixed"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;include&gt;</span>
          <span class="nt">&lt;name&gt;</span>ur10<span class="nt">&lt;/name&gt;</span>
          <span class="nt">&lt;uri&gt;</span>model://ur10<span class="nt">&lt;/uri&gt;</span>
        <span class="nt">&lt;/include&gt;</span>
        <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"attached_to_ground"</span> <span class="na">type=</span><span class="s">"fixed"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;parent&gt;</span>world<span class="nt">&lt;/parent&gt;</span>
            <span class="nt">&lt;child&gt;</span>ur10::base<span class="nt">&lt;/child&gt;</span>
        <span class="nt">&lt;/joint&gt;</span>
    <span class="nt">&lt;/model&gt;</span>
<span class="nt">&lt;/sdf&gt;</span>
</code></pre>
<p>Usually, the first scene one creates is an empty one, which later will give us
an environment in which to test basic functionality, without having to care
about collisions.</p>

<p>In the bundles, scenes are saved in <code>scenes/SCENE_NAME/SCENE_NAME.world</code>, e.g.
<code>scenes/empty_world/empty_world.world</code>:</p>

<pre class="highlight xml"><code><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;sdf</span> <span class="na">version=</span><span class="s">"1.6"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;world</span> <span class="na">name=</span><span class="s">"empty_world"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;include&gt;</span>
      <span class="nt">&lt;uri&gt;</span>model://ur10_fixed<span class="nt">&lt;/uri&gt;</span>
    <span class="nt">&lt;/include&gt;</span>
    <span class="nt">&lt;include&gt;</span>
      <span class="nt">&lt;uri&gt;</span>model://ground_plane<span class="nt">&lt;/uri&gt;</span>
    <span class="nt">&lt;/include&gt;</span>
  <span class="nt">&lt;/world&gt;</span>
<span class="nt">&lt;/sdf&gt;</span>
</code></pre>
<p class="callout callout-warning"><strong>Note</strong> the rock-gazebo integration does not know yet how to download models
from Gazebo's model repository. Run <code>rock-gazebo --gui=gzclient empty_world</code> once first to
make sure the models are downloaded. Wait for the scene to show up (Gazebo's
splash screen disappears then), and quit it then.</p>

<h2 id="running-and-visualizing-a-gazebo-environment">Running and visualizing a Gazebo environment</h2>

<p>Rock offers <code>vizkit3d</code>, its own 3D visualization environment. Since we will
definitely want to augment the visualization of the world with e.g. algorithm
feedback and/or sensor data, we'll be using this environment for the Gazebo
world as well, instead of using Gazebo's client.</p>

<p>The <code>rock-gazebo</code> tool starts a Vizkit3D visualization for the Gazebo scene.</p>

<pre class="highlight plaintext"><code>rock-gazebo empty_world
</code></pre>
<p>Starts both a Gazebo simulation and displays it:</p>

<p><img src="media/initial_rock_gazebo_viz.jpg" alt="Visualization of the simulation state with rock-gazebo-viz" /></p>

<h2 id="syskit_gazebo_configuration">Preparing the <code>gazebo</code> Syskit configuration</h2>

<p>Syskit configuration in bundles may be split into multiple configurations /
environments called "robots". A common organization is to create one bundle
per robot type or project, and create two robot configuration in it, one for
the simulation (<code>gazebo</code>) and one for the live system (<code>live</code>).</p>

<p>Let's create the <code>gazebo</code> configuration:</p>

<pre class="highlight plaintext"><code>$ syskit gen robot gazebo
Bundles[INFO]: Active bundles: syskit_basics
      exists  config/robots
      create  config/robots/gazebo.rb
</code></pre>
<p>In order to setup Syskit to use the Gazebo instance, we first have to require
integration code and then load the environment. This is done by modifying the
newly-created <code>config/robots/gazebo.rb</code> configuration file to add:</p>

<pre class="highlight ruby"><code><span class="no">Robot</span><span class="p">.</span><span class="nf">init</span> <span class="k">do</span>
  <span class="c1">## You can load plugins here</span>
  <span class="c1"># Roby.app.using 'fault_injection'</span>
  <span class="c1"># Roby.app.using 'syskit'</span>

  <span class="c1">## Change the scheduler</span>
  <span class="nb">require</span> <span class="s1">'roby/schedulers/temporal'</span>
  <span class="no">Roby</span><span class="p">.</span><span class="nf">scheduler</span> <span class="o">=</span> <span class="no">Roby</span><span class="o">::</span><span class="no">Schedulers</span><span class="o">::</span><span class="no">Temporal</span><span class="p">.</span><span class="nf">new</span>

  <span class="c1"># The rock-gazebo bridge requires models from the 'common_models' bundle.</span>
  <span class="c1"># It already depends on it, but we need to manually add the bundle to the</span>
  <span class="c1"># Roby search path</span>
  <span class="no">Roby</span><span class="p">.</span><span class="nf">app</span><span class="p">.</span><span class="nf">search_path</span> <span class="o">&lt;&lt;</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'../../../common_models'</span><span class="p">,</span> <span class="n">__dir__</span><span class="p">)</span>
  <span class="nb">require</span> <span class="s1">'rock_gazebo/syskit'</span>
  <span class="no">Conf</span><span class="p">.</span><span class="nf">syskit</span><span class="p">.</span><span class="nf">transformer_enabled</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="no">Robot</span><span class="p">.</span><span class="nf">requires</span> <span class="k">do</span>
  <span class="no">Syskit</span><span class="p">.</span><span class="nf">conf</span><span class="p">.</span><span class="nf">use_gazebo_world</span><span class="p">(</span><span class="s1">'empty_world'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<p>Now that we have a minimal scene and a working Gazebo installation, <a href="composition.html" class="btn btn-primary">let's do
something with it</a></p>

<div class="panel panel-warning">
  <div class="panel-heading">

    <p><a class="btn btn-warning" role="button" data-toggle="collapse" href="#under_the_hood" aria-expanded="false" aria-controls="under_the_hood">
  Advanced
</a><span class="advanced_description">Under the hood: how does the Rock/Gazebo bridge work</span></p>
  </div>
  <div class="collapse panel-body" id="under_the_hood">
    <p>Under the hood, the objects in the Gazebo instance are exposed to the Rock
system by means of <a href="http://gazebosim.org/tutorials?tut=system_plugin">a Gazebo system
plugin</a>. Each model, link,
sensor and some plugins are exposed this way. The plugin is implemented in the
<a href="https://github.com/rock-gazebo/simulation-rock_gazebo"><code>simulation/rock_gazebo</code> package</a>. The components
that implement this interface are implemented in the
<a href="https://github.com/rock-gazebo/simulation-orogen-rock_gazebo"><code>simulation/orogen/rock_gazebo</code> package</a>,
and are being run within the Gazebo process itself, synchronously with the
Gazebo simulation loop. The <code>rock-gazebo</code> and <code>rock-gzserver</code> tools are simple
shell wrappers around the <code>gazebo</code> and <code>gzserver</code> commands, but with the
addition of the system plugin.</p>

    <p>The task contexts in our scene can be visualized with rock-display:</p>

    <p><img src="media/rock_gazebo_task_contexts.jpg" alt="Components exported by a Gazebo instance under Rock" /></p>

    <p><code>rock-gazebo-viz</code> sets up the visualization to match the data in the SDF file and
then listen to pose updates from the <code>rock_gazebo::ModelTask</code> components exposed by the
Gazebo process. Given that this data is only output if the components are running,
<code>rock-gazebo-viz</code> starts them automatically. Use <code>--no-start</code> to avoid this.</p>
  </div>
</div>


            </div>
        </div>
    </div>


        <footer class="container-fluid text-center">
            <p>Rock in your own way!</p>
        </footer>
    </body>
</html>
