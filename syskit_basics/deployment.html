<!DOCTYPE html>
<html lang="en">
    <head>
        <meta content="IE=edge" http-equiv="X-UA-Compatible">
        <meta charset="utf-8">
        <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Robot Construction Toolkit</title>

        <link href="../images/favicon.ico" rel="icon" type="image/ico" relative="true" />
        <link href="../stylesheets/site.css" rel="stylesheet" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <style>
          /* Remove the navbar's default margin-bottom and rounded borders */
          .navbar {
              margin-bottom: 0;
              border-radius: 0;

          }

          /* Set height of the grid so .sidenav can be 100% (adjust as needed) */
          .row.content {height: 450px}

          /* Set gray background color and 100% height */
          .sidenav {
              padding-top: 20px;
              background-color: #f1f1f1;
              height: 100%;
          }

          /* Set black background color, white text and some padding */
          footer {
              background-color: #000000;
              color: white;
              padding: 5px;
          }

          /* On small screens, set height to 'auto' for sidenav and grid */
          @media screen and (max-width: 767px) {
              .sidenav {
                  height: auto;
                  padding: 15px;
              }
              .row.content {height:auto;}
          }
        </style>
    </head>

    <body class="syskit_basics syskit_basics_deployment">

            <!-- top navbar -->
    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav">
                    <li><a href="../">Home</a></li>
                    <li><a href="../about.html">About</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row content">
            <div class="col-sm-3 sidenav">
                <ul><li class='child '><a href="../">Building robots with Rock and Syskit</a></li><li class='parent '><span class='parent-label'><a href="../workspace/">The Workspace</a></span><ul><li class='child '><a href="../workspace/">Introduction</a></li><li class='child '><a href="../workspace/day_to_day.html">Day-to-day</a></li></ul></li><li class='parent '><span class='parent-label'><a href="./">Basics</a></span><ul><li class='child '><a href="./">Introduction</a></li><li class='child '><a href="getting_started.html">Getting Started</a></li><li class='child '><a href="composition.html">Compositions</a></li><li class='child '><a href="constant_generator.html">Constant Generator</a></li><li class='child '><a href="devices.html">Devices</a></li><li class='child active'><a href="deployment.html">Deployment</a></li><li class='child '><a href="recap.html">Recap</a></li></ul></li><li class='parent '><span class='parent-label'><a href="../transformations/">Transformations</a></span><ul><li class='child '><a href="../transformations/">Geometric Relations</a></li></ul></li></ul>
            </div>
            <div class="col-sm-7 text-left">
                <h1 id="deployment">Deployment</h1>

<p>A few things are missing before we can actually run <a href="devices.html">the network we just
created</a>:</p>

<ol>
  <li><a href="#use_deployment">Deploy the components</a></li>
  <li><a href="#configuration">Configure the components</a></li>
  <li><a href="#actions">Export the network as a Syskit Action so that we can instruct Syskit to start it</a></li>
</ol>

<h2 id="use_deployment">Component deployment</h2>

<p>When declared in oroGen files, components are a functional encapsulation of a
function. At this stage, a "component" is really just a class which embeds code
in a specific, normalized way, and that has predefined inputs, outputs and
configuration parameters.</p>

<p>To actually run a component, one needs to declare how it will be supported by
the operating system's runtime ressources (how the components are mapped to
processes and threads), and when the component will be processing its data
(periodically, triggered by its inputs). Moreover, the component is given a name
so that it can be discovered by Rock's inspection tools, and so that its outputs
can be found in the data logged at runtime.</p>

<p>All oroGen components have a default deployment scheme of one component per
process. The triggering mechanism does not have a default, but the
<code>port_driven</code> scheme (where the component is triggered whenever data is
received on its inputs) is a very common scheme. If you look into the
<code>cart_ctrl_wdls</code> package, you would see that it's what the package's components
use.</p>

<p id="requires">One usually starts with the defaults defined in the oroGen file. We therefore
only have left to give a name to the components Syskit is using. This is done
in the robot's config file with:</p>

<pre class="highlight ruby"><code><span class="no">Robot</span><span class="p">.</span><span class="nf">requires</span> <span class="k">do</span>
  <span class="no">Syskit</span><span class="p">.</span><span class="nf">conf</span><span class="p">.</span><span class="nf">use_gazebo_world</span><span class="p">(</span><span class="s1">'empty_world'</span><span class="p">)</span>

  <span class="nb">require</span> <span class="s1">'models/profiles/gazebo/arm_control'</span>
  <span class="no">Syskit</span><span class="p">.</span><span class="nf">conf</span><span class="p">.</span><span class="nf">use_deployment</span> <span class="s1">'cart_ctrl_wdls::CartCtrl'</span> <span class="o">=&gt;</span> <span class="s1">'arm_pos2twist'</span>
  <span class="no">Syskit</span><span class="p">.</span><span class="nf">conf</span><span class="p">.</span><span class="nf">use_deployment</span> <span class="s1">'cart_ctrl_wdls::WDLSSolver'</span> <span class="o">=&gt;</span> <span class="s1">'arm_twist2joint'</span>
  <span class="no">Syskit</span><span class="p">.</span><span class="nf">conf</span><span class="p">.</span><span class="nf">use_deployment</span> <span class="s1">'robot_frames::SingleChainPublisher'</span> <span class="o">=&gt;</span> <span class="s1">'arm_chain_publisher'</span>
  <span class="no">Syskit</span><span class="p">.</span><span class="nf">conf</span><span class="p">.</span><span class="nf">use_ruby_tasks</span> <span class="no">SyskitBasics</span><span class="o">::</span><span class="no">Compositions</span><span class="o">::</span><span class="no">ArmCartesianConstantCommandGenerator</span> <span class="o">=&gt;</span> <span class="s1">'arm_constant_setpoint'</span>
  <span class="no">Syskit</span><span class="p">.</span><span class="nf">conf</span><span class="p">.</span><span class="nf">use_ruby_tasks</span> <span class="no">SyskitBasics</span><span class="o">::</span><span class="no">Compositions</span><span class="o">::</span><span class="no">JointPositionConstantGenerator</span> <span class="o">=&gt;</span> <span class="s1">'joint_position_setpoint'</span>
<span class="k">end</span>
</code></pre>
<p class="callout callout-info">Now that we've required our toplevel profile in the robot configuration file,
we can inspect our app using the IDE by simply providing the <code>-rgazebo</code> flag.
Only new files, not yet required by the config file, must be specified on the
command line.</p>

<h2 id="configuration">Component configuration</h2>

<p>Configuration of components in a Syskit system is split into two parts:</p>

<ul>
  <li>"dynamic" configuration: parameters that cannot be known at design time, will
be changed each time an action is started, or are to be kept consistent
system-wide (such as e.g. information that can be extracted from the SDF
model). These are represented as <strong>task arguments</strong>. This is how the
setpoint
of the cartesian controller <a href="constant_generator.html">is handled</a>.</li>
  <li>"static" configuration: parameters that are known at design time. Most
of the algorithm parameters fit into this category. These are the subject
of this section.</li>
</ul>

<h3 id="static-configuration-of-orogen-components">Static configuration of oroGen components</h3>

<p>The static configuration is stored within YAML files in <code>config/orogen/</code>. Each
file is named after the component model that is configured, so for instance
<code>config/orogen/cart_ctrl_wdls::WDLSSolver</code> stores the configuration of all
components under that name. Each file can contain multiple configurations
within sections, but for now we'll only use the <code>default</code> configuration,
which is the one that is loaded by default unless specified otherwise.</p>

<p>Let's generate configuration file templates for the components we are using. The
files are generated with the default configuration exposed by the components.</p>

<pre class="highlight plaintext"><code>$ syskit gen orogenconf cart_ctrl_wdls::WDLSSolver
      create  config/orogen/
      create  config/orogen/cart_ctrl_wdls::WDLSSolver.yml
$ syskit gen orogenconf cart_ctrl_wdls::CartCtrl
      exists  config/orogen/
      create  config/orogen/cart_ctrl_wdls::CartCtrl.yml
$ syskit gen orogenconf robot_frames::SingleChainPublisher
      exists  config/orogen/
      create  config/orogen/robot_frames::SingleChainPublisher.yml
</code></pre>
<p>Each properties in the generated files have their corresponding configuration.
Let's look at them one by one, to see what needs to actually be configured.</p>

<ul>
  <li><code>cart_ctrl_wdls::WDLSSolver</code>. There are robot model parameters as well as tip
and root. The former should be extracted from the SDF configuration, but the
tip and root have to be set. The only algorithm parameter that does not seem to
have a sane default is the <code>lambda</code> parameter. The documentation mentions 0.1
has a known-good parameter for some arm, let's pick that and keep in mind
that it might be wrong.</li>
  <li><code>cart_ctrl_wdls::CartCtrl</code>. The one parameter that is probably best changed is
the max output. The component's designer decided to pick <code>RigidBodyState</code> to
represent a twist, which means that we only need to update the velocity
and angular velocity fields. Let's set <code>0.1</code> in linear and <code>2.deg</code> in angular
(the <code>.deg</code> suffix will convert a degree value in radians).</li>
  <li><code>robot_frames::SingleChainPublisher</code> only has robot model that we will
extract from the SDF model, and the tip/root parameters that have to be set</li>
</ul>

<p class="callout callout-info"><strong>Note</strong> in order to ensure consistency between the tip and root parameters of
<code>SingleChainPublisher</code> and <code>WDLSSolver</code>, another way to handle this is to make
them parameters of the compositions.</p>

<p>The root and tip in our case are the base and hand of the robot. The link names are prefixed
with the model name (here, <code>ur10_fixed</code>) so <code>root</code> should
be <code>ur10_fixed::ur10::base</code> and <code>tip</code> should be <code>ur10_fixed::ur10::wrist_3</code>. One can find this out by looking at
the SDF file.  Alternatively, the chain can be
inspected using the <code>rock-transformer</code> tool:</p>

<div class="fluid-video">
<iframe width="853" height="480" src="https://www.youtube.com/embed/ShYmPgIZ1Oc?rel=0&amp;showinfo=0" frameborder="0" allowfullscreen=""></iframe>
</div>

<h3 id="dynamic-and-system-wide-configuration">Dynamic and system-wide configuration</h3>

<p>The robot model need to be extracted from the SDF and passed to the components
that require it. The convention when integrating SDF models in Syskit is to
extract the relevant parts of the XML model as an XML string and provide only
this to the components. This centralizes the difficulty of resolving the
relationships between SDF models, and provides flexibility to tune the model
before it is passed to the component.</p>

<div class="panel panel-warning">
  <div class="panel-heading">
    <p><a class="btn btn-warning" role="button" data-toggle="collapse" href="#sdf_load" aria-expanded="false" aria-controls="sdf_load">
  Advanced
</a><span class="advanced_description">Mechanisms involved in SDF file loading in Rock</span></p>
  </div>

  <div class="collapse panel-body" id="sdf_load">
    <p>The difficulty when loading a SDF file is that SDF allows files to refer to
each other through the include mechanism, which can be used in a
<a href="http://sdformat.org/spec?ver=1.6&amp;elem=world#world_include">world</a> as well as a
<a href="http://sdformat.org/spec?ver=1.6&amp;elem=model#model_include">model</a> tag. Within
Gazebo, the include tags are resolved by searching through the
<code>GAZEBO_MODEL_PATH</code> environment variable. The SDF integration in Syskit automatically
augments this environment variable with the <code>models/sdf/</code> folders found within the <a href="getting_started.html#syskit_gazebo_configuration">app search path</a>.</p>

    <p>In order to avoid complexities tied to this mechanism, the preferred way to integrate SDF in components in a Syskit system is to provide the XML model as a string instead of as a file. This ensures that Syskit and the components share the same model.</p>
  </div>
</div>

<p>The <code>use_sdf_model</code> statement stores the model object on the profile object.
The most natural way would be to pass the <code>Base</code> profile, that represents the
robot model, as a <code>robot</code> argument to the control compositions until the oroGen
components. We can then make sure that argument is passed to the oroGen components
themselves.</p>

<p>We've already seen <a href="constant_generator.html#composition_forward_argument">how to forward a composition argument to its child</a>, so let's apply that to the compositions:</p>

<p>In <code>models/compositions/arm_cartesian_constant_control_wdls.rb</code></p>

<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">ArmCartesianConstantControlWdls</span> <span class="o">&lt;</span> <span class="no">Syskit</span><span class="o">::</span><span class="no">Composition</span>
  <span class="c1"># The robot model that is to be used</span>
  <span class="c1">#</span>
  <span class="c1"># This must be the enclosing profile object that has the use_sdf_model call</span>
  <span class="c1">#</span>
  <span class="c1"># @return [Profile]</span>
  <span class="n">argument</span> <span class="ss">:robot</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
  <span class="nf">add</span><span class="p">(</span><span class="no">ArmCartesianControlWdls</span><span class="p">,</span> <span class="ss">as: </span><span class="s1">'control'</span><span class="p">).</span>
    <span class="nf">with_arguments</span><span class="p">(</span><span class="ss">robot: </span><span class="n">from</span><span class="p">(</span><span class="ss">:parent_task</span><span class="p">).</span><span class="nf">robot</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<p>and in <code>models/compositions/arm_cartesian_control_wdls.rb</code></p>

<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">ArmCartesianControlWdls</span> <span class="o">&lt;</span> <span class="no">Syskit</span><span class="o">::</span><span class="no">Composition</span>
  <span class="c1"># The robot model that is to be used</span>
  <span class="c1">#</span>
  <span class="c1"># This must be the enclosing profile object that has the use_sdf_model call</span>
  <span class="c1">#</span>
  <span class="c1"># @return [Profile]</span>
  <span class="n">argument</span> <span class="ss">:robot</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
  <span class="nf">add</span><span class="p">(</span><span class="no">OroGen</span><span class="o">::</span><span class="no">CartCtrlWdls</span><span class="o">::</span><span class="no">WDLSSolver</span><span class="p">,</span> <span class="ss">as: </span><span class="s1">'twist2joint_velocity'</span><span class="p">).</span>
    <span class="nf">with_arguments</span><span class="p">(</span><span class="ss">robot: </span><span class="n">from</span><span class="p">(</span><span class="ss">:parent_task</span><span class="p">).</span><span class="nf">robot</span><span class="p">)</span>
  <span class="n">add</span><span class="p">(</span><span class="no">OroGen</span><span class="o">::</span><span class="no">RobotFrames</span><span class="o">::</span><span class="no">SingleChainPublisher</span><span class="p">,</span> <span class="ss">as: </span><span class="s1">'joint2pose'</span><span class="p">).</span>
    <span class="nf">with_arguments</span><span class="p">(</span><span class="ss">robot: </span><span class="n">from</span><span class="p">(</span><span class="ss">:parent_task</span><span class="p">).</span><span class="nf">robot</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<p>Since the <code>ArmControl</code> profile is specific to the <code>gazebo</code> robot, we can inject
the relevant robot in the profile directly:</p>

<pre class="highlight ruby"><code><span class="n">define</span> <span class="s1">'arm_cartesian_constant_control'</span><span class="p">,</span>
  <span class="no">Compositions</span><span class="o">::</span><span class="no">ArmCartesianConstantControlWdls</span><span class="p">.</span>
    <span class="nf">use</span><span class="p">(</span><span class="no">Base</span><span class="p">.</span><span class="nf">ur10_fixed_dev</span><span class="p">).</span>
    <span class="nf">with_arguments</span><span class="p">(</span><span class="ss">robot: </span><span class="no">Base</span><span class="p">)</span>
</code></pre>
<p id="orogen_extension_files">We now need to modify the oroGen component models to use the robot argument.
Since oroGen components are auto-generated by Syskit, there's a special
mechanism to allow modifying the generated classes after the fact. When Syskit
loads an oroGen package, and after it has created the task classes, it will attempt to
load a file named like the project in <code>models/orogen/</code>. In the case of the
<code>robot_frames</code> project, this would be <code>models/orogen/robot_frames.rb</code>.</p>

<p>In the IDE, when displaying a task model under the <code>OroGen</code> namespace, a project
that has no associated extension file in <code>models/orogen/</code> has the following message:</p>

<p><img src="media/no_extension_file.png" alt="Message displayed by the IDE if there are no extension files" /></p>

<p>Let's do exactly that</p>

<pre class="highlight plaintext"><code>$ syskit gen orogen cart_ctrl_wdls
      create  models/orogen
      create  test/orogen
      create  models/orogen/cart_ctrl_wdls.rb
      create  test/orogen/test_cart_ctrl_wdls.rb
$ syskit gen orogen robot_frames
      exists  models/orogen
      exists  test/orogen
      create  models/orogen/robot_frames.rb
      create  test/orogen/test_robot_frames.rb
</code></pre>
<p>After hitting the IDE's reload button, we now get the path to the extension file:</p>

<p><img src="media/orogen_extension_file.png" alt="Message displayed by the IDE if there is an extension files" /></p>

<p>Now, let's edit <code>models/orogen/cart_ctrl_wdls.rb</code>. There is one <code>class</code>
statement per task model in the project, but we're currently only interested in
the <code>WDLSSolver</code> task. Let's add the <code>robot</code> argument, and tune the
<code>configure</code> method that is described in the template to forward the model on to
the task's properties.</p>

<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">OroGen</span><span class="o">::</span><span class="no">CartCtrlWdls</span><span class="o">::</span><span class="no">WDLSSolver</span>
  <span class="n">argument</span> <span class="ss">:robot</span>
  <span class="k">def</span> <span class="nf">configure</span>
    <span class="k">super</span> <span class="c1"># call super as described in the template</span>

    <span class="n">properties</span><span class="p">.</span><span class="nf">robot_model</span> <span class="o">=</span> <span class="n">robot</span><span class="p">.</span><span class="nf">sdf_model</span><span class="p">.</span><span class="nf">make_root</span><span class="p">.</span><span class="nf">to_xml_string</span>
    <span class="n">properties</span><span class="p">.</span><span class="nf">robot_model_format</span> <span class="o">=</span> <span class="ss">:ROBOT_MODEL_SDF</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<p>and in <code>models/orogen/robot_frames.rb</code>:</p>

<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">OroGen</span><span class="o">::</span><span class="no">RobotFrames</span><span class="o">::</span><span class="no">SingleChainPublisher</span>
  <span class="n">argument</span> <span class="ss">:robot</span>
  <span class="k">def</span> <span class="nf">configure</span>
    <span class="k">super</span> <span class="c1"># call super as described in the template</span>

    <span class="n">properties</span><span class="p">.</span><span class="nf">robot_model</span> <span class="o">=</span> <span class="n">robot</span><span class="p">.</span><span class="nf">sdf_model</span><span class="p">.</span><span class="nf">make_root</span><span class="p">.</span><span class="nf">to_xml_string</span>
    <span class="n">properties</span><span class="p">.</span><span class="nf">robot_model_format</span> <span class="o">=</span> <span class="ss">:ROBOT_MODEL_SDF</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<p>Now, to ensure consistency, we should verify that the <code>tip</code> and <code>root</code>
properties are set to actual links in the provided model. Let's do this in
<code>WDLSSolver</code>:</p>

<pre class="highlight ruby"><code><span class="n">argument</span> <span class="ss">:robot</span>

<span class="c1"># @api private</span>
<span class="c1">#</span>
<span class="c1"># Validates that a link is part of the provided robot model</span>
<span class="c1">#</span>
<span class="c1"># @param [String] link_name the name of the link</span>
<span class="c1"># @param [String] property_name the name of the property being</span>
<span class="c1">#   verified</span>
<span class="c1"># @raise [ArgumentError] if the link is not in the model</span>
<span class="k">def</span> <span class="nf">verify_link_in_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">link_name</span><span class="p">)</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">model</span><span class="p">.</span><span class="nf">each_link</span><span class="p">.</span><span class="nf">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span> <span class="n">link</span><span class="p">.</span><span class="nf">full_name</span> <span class="o">==</span> <span class="n">link_name</span> <span class="p">}</span>
    <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">"link name '</span><span class="si">#{</span><span class="n">link_name</span><span class="si">}</span><span class="s2">' is not a link of the robot model. Existing links: </span><span class="si">#{</span><span class="n">model</span><span class="p">.</span><span class="nf">each_link</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:full_name</span><span class="p">).</span><span class="nf">sort</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">", "</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">configure</span>
  <span class="k">super</span>

  <span class="c1"># Extract the model into its own SDF document</span>
  <span class="n">as_root</span> <span class="o">=</span> <span class="n">robot</span><span class="p">.</span><span class="nf">sdf_model</span><span class="p">.</span><span class="nf">make_root</span>
  <span class="c1"># And get the new model</span>
  <span class="n">model</span> <span class="o">=</span> <span class="n">as_root</span><span class="p">.</span><span class="nf">each_model</span><span class="p">.</span><span class="nf">first</span>
  <span class="n">verify_link_in_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">properties</span><span class="p">.</span><span class="nf">root</span><span class="p">)</span>
  <span class="n">verify_link_in_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">properties</span><span class="p">.</span><span class="nf">tip</span><span class="p">)</span>

  <span class="n">properties</span><span class="p">.</span><span class="nf">robot_model</span> <span class="o">=</span> <span class="n">as_root</span><span class="p">.</span><span class="nf">to_xml_string</span>
  <span class="n">properties</span><span class="p">.</span><span class="nf">robot_model_format</span> <span class="o">=</span> <span class="ss">:ROBOT_MODEL_SDF</span>
<span class="k">end</span>
</code></pre>
<div class="panel panel-warning">
  <div class="panel-heading">
    <p><a class="btn btn-warning" role="button" data-toggle="collapse" href="#lib_helpers" aria-expanded="false" aria-controls="lib_helpers">
  Advanced
</a><span class="advanced_description">Writing helpers in Syskit apps</span></p>
  </div>

  <div class="collapse panel-body" id="lib_helpers">
    <p>The <code>verify_link_in_model</code> functionality is obviously a good target for
being factored out as a standalone helper. In Syskit apps, these helpers
are stored within the <code>lib/&lt;app_name&gt;/</code> folder (e.g. <code>lib/syskit_basics/</code>).
Corresponding tests are stored in <code>test/lib/</code>.</p>

    <p>In this case, one would create a <code>lib/syskit_basics/sdf_helpers.rb</code> file with a <code>SyskitBasics::SDFHelpers</code> module that contains</p>

<pre class="highlight ruby"><code><span class="c1"># Validates that a link is part of the provided robot model</span>
<span class="c1">#</span>
<span class="c1"># @param [SDF::Model] sdf_model the SDF model</span>
<span class="c1"># @param [String] link_name the name of the link</span>
<span class="c1"># @raise [ArgumentError] if the link is not in the model</span>
<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">verify_link_in_model</span><span class="p">(</span><span class="n">sdf_model</span><span class="p">,</span> <span class="n">link_name</span><span class="p">)</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">sdf_model</span><span class="p">.</span><span class="nf">each_link</span><span class="p">.</span><span class="nf">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span> <span class="n">link</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="n">link_name</span> <span class="p">}</span>
    <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">"link name '</span><span class="si">#{</span><span class="n">link_name</span><span class="si">}</span><span class="s2">' is not a link of the robot model. Existing links: </span><span class="si">#{</span><span class="n">sdf_model</span><span class="p">.</span><span class="nf">each_link</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">).</span><span class="nf">sort</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">", "</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
  </div>
</div>

<p>As for the constant generator, we should <a href="constant_generator.html#testing">test the
functionality</a>.  The <code>syskit gen orogen</code> call
created a test template. Let's modify it to test the setup for <code>WDLSSolver</code>.
The modifications for <code>SingleChainPublisher</code> will be left to the reader :P</p>

<pre class="highlight ruby"><code><span class="n">describe</span> <span class="no">WDLSSolver</span> <span class="k">do</span>
  <span class="kp">attr_reader</span> <span class="ss">:profile</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="c1"># Create a mock that has a robot model</span>
    <span class="n">xml</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="no">EOSDF</span><span class="sh">
      &lt;model name='test'&gt;
        &lt;link name="root_test" /&gt;
        &lt;link name="tip_test" /&gt;
      &lt;/model&gt;
</span><span class="no">      EOSDF</span>
    <span class="c1"># We don't really need a full profile object, only an object</span>
    <span class="c1"># that provides a Model object from a '#sdf_model' attribute</span>
    <span class="c1">#</span>
    <span class="c1"># Let's fake one using flexmock. Flexmock is loaded as part</span>
    <span class="c1"># Of Syskit's test harness</span>
    <span class="c1">#</span>
    <span class="c1"># https://github.com/doudou/flexmock</span>
    <span class="vi">@profile</span> <span class="o">=</span> <span class="n">flexmock</span><span class="p">(</span><span class="ss">sdf_model: </span><span class="no">SDF</span><span class="o">::</span><span class="no">Model</span><span class="p">.</span><span class="nf">from_xml_string</span><span class="p">(</span><span class="n">xml</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"sets the robot model from its 'robot' argument"</span> <span class="k">do</span>
    <span class="c1"># Create a fake test configuration with valid root and tip</span>
    <span class="n">syskit_stub_conf</span> <span class="no">WDLSSolver</span><span class="p">,</span> <span class="s1">'default'</span><span class="p">,</span>
      <span class="ss">data: </span><span class="p">{</span> <span class="s1">'root'</span> <span class="o">=&gt;</span> <span class="s1">'test::root_test'</span><span class="p">,</span> <span class="s1">'tip'</span> <span class="o">=&gt;</span> <span class="s1">'test::tip_test'</span> <span class="p">}</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">syskit_stub_deploy_and_configure</span><span class="p">(</span>
      <span class="no">WDLSSolver</span><span class="p">.</span><span class="nf">with_arguments</span><span class="p">(</span><span class="ss">robot: </span><span class="n">profile</span><span class="p">))</span>
    <span class="n">assert_equal</span> <span class="s2">"&lt;sdf&gt;</span><span class="si">#{</span><span class="n">profile</span><span class="p">.</span><span class="nf">sdf_model</span><span class="p">.</span><span class="nf">to_xml_string</span><span class="si">}</span><span class="s2">&lt;/sdf&gt;"</span><span class="p">,</span>
      <span class="n">task</span><span class="p">.</span><span class="nf">properties</span><span class="p">.</span><span class="nf">robot_model</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"raises if the root link does not exist"</span> <span class="k">do</span>
    <span class="n">syskit_stub_conf</span> <span class="no">WDLSSolver</span><span class="p">,</span> <span class="s1">'default'</span><span class="p">,</span>
      <span class="ss">data: </span><span class="p">{</span> <span class="s1">'root'</span> <span class="o">=&gt;</span> <span class="s1">'invalid'</span><span class="p">,</span> <span class="s1">'tip'</span> <span class="o">=&gt;</span> <span class="s1">'test::tip_test'</span> <span class="p">}</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">assert_raises</span><span class="p">(</span><span class="no">ArgumentError</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">syskit_stub_deploy_and_configure</span><span class="p">(</span>
        <span class="no">WDLSSolver</span><span class="p">.</span><span class="nf">with_arguments</span><span class="p">(</span><span class="ss">robot: </span><span class="n">profile</span><span class="p">))</span>
    <span class="k">end</span>
    <span class="n">assert_equal</span> <span class="s2">"link name 'invalid' is not a link of the robot model. Existing links: test::root_test, test::tip_test"</span><span class="p">,</span>
      <span class="n">e</span><span class="p">.</span><span class="nf">message</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"raises if the tip link does not exist"</span> <span class="k">do</span>
    <span class="n">syskit_stub_conf</span> <span class="no">WDLSSolver</span><span class="p">,</span> <span class="s1">'default'</span><span class="p">,</span>
      <span class="ss">data: </span><span class="p">{</span> <span class="s1">'root'</span> <span class="o">=&gt;</span> <span class="s1">'test::root_test'</span><span class="p">,</span> <span class="s1">'tip'</span> <span class="o">=&gt;</span> <span class="s1">'invalid'</span> <span class="p">}</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">assert_raises</span><span class="p">(</span><span class="no">ArgumentError</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">syskit_stub_deploy_and_configure</span><span class="p">(</span>
        <span class="no">WDLSSolver</span><span class="p">.</span><span class="nf">with_arguments</span><span class="p">(</span><span class="ss">robot: </span><span class="n">profile</span><span class="p">))</span>
    <span class="k">end</span>
    <span class="n">assert_equal</span> <span class="s2">"link name 'invalid' is not a link of the robot model. Existing links: test::root_test, test::tip_test"</span><span class="p">,</span>
      <span class="n">e</span><span class="p">.</span><span class="nf">message</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<p>And run the tests either <a href="constant_generator.html#run_test_command_line">on the command line</a> or <a href="constant_generator.html#run_test_ide">with the IDE</a>.</p>

<p>The tests for <code>WDLSSolver</code> we just wrote should pass. However, we get an error for <code>AdaptiveWDLSSolver</code>:</p>

<pre class="highlight plaintext"><code>  1) Error:
OroGen::CartCtrlWdls::AdaptiveWDLSSolver#test_0001_anonymous:


cannot find an ordering to configure 1 tasks
OroGen::CartCtrlWdls::AdaptiveWDLSSolver:0x5e5bbb8
  owners: 
  arguments: 
    orocos_name: "task_under_test",
    conf: ["default"]
  ready_for_setup? false
  missing_arguments: robot
  has no should_configure_after constraint
    /home/doudou/dev/vanilla/rock-website/tools/syskit/lib/syskit/test/network_manipulation.rb:788:in `syskit_configure'
    /home/doudou/dev/vanilla/rock-website/tools/syskit/lib/syskit/test/network_manipulation.rb:1023:in `syskit_deploy_and_configure'
    /home/doudou/dev/vanilla/rock-website/tools/syskit/lib/syskit/test/task_context_test.rb:63:in `assert_is_configurable'
    /home/doudou/dev/vanilla/rock-website/tools/syskit/lib/syskit/test/task_context_test.rb:75:in `is_configurable'
    /home/doudou/dev/vanilla/rock-website/bundles/syskit_basics/test/orogen/test_cart_ctrl_wdls.rb:55:in `block (2 levels) in &lt;module:CartCtrlWdls&gt;'
</code></pre>
<p>With the <code>missing_arguments:</code> line <a href="constant_generator.html#missing_arguments">we've already seen</a>.</p>

<p>Looking at <code>AdaptiveWDLSSolver</code>, we can see that it is subclassing <code>WDLSSolver</code>:</p>

<p><img src="media/adaptive_wdlssolver_subclassed_from.png" alt="AdaptiveWDLSSolver subclassed from WDLSSolver" /></p>

<p>This is reflected in the class hierarchy on the Syskit side, which means that
<code>AdaptiveWDLSSolver</code> does inherit the <code>configure</code> method we just wrote. Given
that it does not overload this method itself, we can just delete the test.</p>

<h2 id="actions">Building the system's action interface</h2>

<p>A Syskit application exports functionality to the outside world as <em>actions</em>.
For now, the only thing we'll see about actions is that they have a name,
arguments and a lifetime. They either finish by themselves – if they have a
goal – or run forever until they are "dropped" by the app's user.</p>

<p>What we will see here is how to export the <a href="devices.html#profile_define">profile
definition</a> as an action on the robot's action
interface so that we can finally start it.</p>

<p>Every robot have a 'main' interface that is setup in the robot configuration
file. Syskit profiles are added in the action interface there, so that their
definitions are exported as an action with a <code>_def</code> suffix.</p>

<p id="main">Let's modify the <code>actions</code> block in <code>config/robots/gazebo.rb</code> to have:</p>

<pre class="highlight ruby"><code><span class="no">Robot</span><span class="p">.</span><span class="nf">actions</span> <span class="k">do</span>
  <span class="n">use_profile</span> <span class="no">SyskitBasics</span><span class="o">::</span><span class="no">Profiles</span><span class="o">::</span><span class="no">Gazebo</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">use_profile</span> <span class="no">SyskitBasics</span><span class="o">::</span><span class="no">Profiles</span><span class="o">::</span><span class="no">Gazebo</span><span class="o">::</span><span class="no">ArmControl</span>
<span class="k">end</span>
</code></pre>
<p class="callout callout-info"><strong>Note</strong>: the profile is available in the actions block because <a href="#requires">we've required it in the requires block</a></p>

<p>After modifying the config file, the IDE needs to be quit and started again. We
can then look at the <code>Main</code> interface and see that it indeed has <code>_dev</code> actions for
the devices in <code>Base</code>, and <code>_def</code> actions for the definitions in <code>ArmControl</code>.</p>

<p><img src="media/main_action_with_arm_control_def.png" alt="The Main interface with the arm control definition" /></p>

<p>Let's now run it</p>

<h2 id="running-the-simulation-and-app">Running the simulation and app</h2>

<p>Start the simulation with</p>

<pre class="highlight plaintext"><code>rock-gazebo empty_world
</code></pre>
<p>Once started, the simulation can stay running regardless of whether the Syskit
app itself gets restarted. You can then start the app using the IDE, and
send the command through the Syskit shell. The following video show you the process. Its goal
is to give you a feeling for Syskit's runtime workflow. Detailed explanations will come later <a href="../syskit_runtime/index.html">in the runtime part of this documentation</a></p>

<div class="fluid-video">
<iframe width="853" height="480" src="https://www.youtube.com/embed/wXYb7f_xNZo?rel=0&amp;showinfo=0" frameborder="0" allowfullscreen=""></iframe>
</div>

<p>Before we move on to the Syskit runtime aspects, <a href="recap.html" class="btn btn-primary">let's recap what we've just seen</a></p>

            </div>
        </div>
    </div>


        <footer class="container-fluid text-center">
            <p>Rock in your own way!</p>
        </footer>
    </body>
</html>
