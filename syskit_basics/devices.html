<!DOCTYPE html>
<html lang="en">
    <head>
        <meta content="IE=edge" http-equiv="X-UA-Compatible">
        <meta charset="utf-8">
        <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Robot Construction Toolkit</title>

        <link href="../images/favicon.ico" rel="icon" type="image/ico" relative="true" />
        <link href="../stylesheets/site.css" rel="stylesheet" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    </head>

    <body class="syskit_basics syskit_basics_devices">
            <!-- top navbar -->
    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav">
                    <li><a href="../">Home</a></li>
                    <li><a href="../about.html">About</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3" role="complementary">
                <nav class="docs-sidebar" data-spy="affix">
                    <ul class="nav"><li class='child'><a href="../">Building robots with Rock and Syskit</a></li><li class='parent'><span class='parent-label'><a href="../workspace/">The Workspace</a></span><ul><li class='child'><a href="../workspace/">Introduction</a></li><li class='child'><a href="../workspace/day_to_day.html">Day-to-day</a></li></ul></li><li class='parent active'><span class='parent-label'><a href="./">Basics</a></span><ul><li class='child'><a href="./">Introduction</a></li><li class='child'><a href="getting_started.html">Getting Started</a></li><li class='child'><a href="composition.html">Compositions</a></li><li class='child'><a href="constant_generator.html">Constant Generator</a></li><li class='child active'><a href="devices.html">Devices</a></li><li class='child'><a href="deployment.html">Deployment</a></li><li class='child'><a href="recap.html">Recap</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../syskit_runtime/">Runtime</a></span><ul><li class='child'><a href="../syskit_runtime/">Introduction</a></li><li class='child'><a href="../syskit_runtime/task_structure.html">Task Structures</a></li><li class='child'><a href="../syskit_runtime/event_loop.html">Event Loop</a></li><li class='child'><a href="../syskit_runtime/exceptions.html">Exceptions</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../syskit_coordination/">Coordination</a></span><ul><li class='child'><a href="../syskit_coordination/">Introduction</a></li></ul></li></ul>
                </nav>
            </div>
            <div class="col-md-9" role="main">
                <h1 id="devices">Devices</h1>

<p>So far, we have a control composition. But as we noticed when we created <a href="composition.html">the
arm control network</a>, it is not using a real component as the
arm, only a device model. This page will be talking about devices, and telling
how one replaces the device model by something that can be run.</p>

<p>One can partition a component network into three categories:</p>

<ul>
  <li>source of data</li>
  <li>sinks of data</li>
  <li>transformation of data</li>
</ul>

<p>Within a robotic system, the source and sinks of data are the sensors and
actuators of the robot itself. What makes them unique when building the system's
component network is that they are indeed <em>unique</em>.</p>

<p>While the data processing components can easily be duplicated - an image
preprocessing component can be instantiated multiple times to process multiple
streams of data - one cannot duplicate devices.  They are bound to hardware,
and we still don't know how to grow new devices on the robot on-demand.</p>

<p>This difference also exists in the Syskit system. The robot interface, the
devices, are described separately. We will now see how this is done, and
how we can use these devices within our arm control network, binding the
simulated arm with the control network.</p>

<h2 id="defining-devices-for-the-gazebo-system">Defining devices for the Gazebo system</h2>

<p>The robot definition is done within a Syskit <em>profile</em>. Profiles are the models
that bind network definitions (compositions) with devices and other
compositions. It's also where the robot definition happens.</p>

<p>As a matter of convention, one usually creates a per-robot <code>Base</code> profile that
contains the robot definition.  Let's do that now.</p>

<div class="highlight"><pre class="highlight plaintext"><code>$ syskit gen profile -rgazebo base
      create  models/profiles/gazebo
      create  models/profiles/gazebo/base.rb
      create  test/profiles/gazebo
      create  test/profiles/gazebo/test_base.rb
</code></pre></div>
<p class="callout callout-warning">Note how the addition of <code>-rgazebo</code> to the command line ensured that the model
is generated within the <code>gazebo/</code> subdirectory of the <code>profiles/</code> folder and
within the <code>Gazebo</code> namespace of <code>Profiles</code>. This is a general convention (e.g.
compositions specific to our <code>gazebo</code> robot would be in <code>compositions/gazebo/</code> and
within the <code>Compositions::Gazebo</code> namespace.</p>

<p>Now, here's the catch: we will actually not really learn to define devices, since
the mapping from the simulation model to devices is done automatically from the
robot model. One only has to declare the robot model in the <code>Base</code> profile:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="k">module</span> <span class="nn">SyskitBasics</span>
  <span class="k">module</span> <span class="nn">Profiles</span>
    <span class="k">module</span> <span class="nn">Gazebo</span>
      <span class="n">profile</span> <span class="s1">'Base'</span> <span class="k">do</span>
        <span class="n">use_gazebo_model</span> <span class="s1">'model://ur10_fixed/model.sdf'</span>
        <span class="n">use_sdf_world</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>And have a look at the generated devices with <code>syskit ide -rgazebo models/profiles/gazebo/base.rb</code>:</p>

<p><img src="media/devices.png" alt="Devices from the UR10 model" class="fullwidth" /></p>

<p>One can see that there is one device definition per link in the model, and one
for the model itself. Let's click on the model and have a look at the dataflow.
Enable both "Show all ports" and "Show task info" to get port information .</p>

<p><img src="media/device_dataflow.png" alt="ModelTask interface" class="fullwidth" /></p>

<h2 id="profile_define">Injecting the device into the arm control network</h2>

<p>As said, profiles is where this kind of injection is done. But let's keep <code>Base</code>
for really low-level stuff like devices. Let's create an <code>ArmControl</code> profile to
integrate the arm control stuff.</p>

<div class="highlight"><pre class="highlight plaintext"><code>syskit gen profile -rgazebo ArmControl
</code></pre></div>
<p>We need to require the <code>Base</code> profile and <code>ArmCartesianControlWdls</code> composition
definition.  Then, <code>define</code> the cartesian and joint position controls <em>for our
UR10 robot in gazebo</em> by injecting the UR10 device as the 'arm' child of the
composition.</p>

<p class="callout callout-warning">The model name given to <code>define</code> in a profile is made out of a <a href="https://martinfowler.com/bliki/FluentInterface.html">demeter
chain</a>. In Ruby, one can
easily break the chain with a newline after each method call. Don't forget the
dots !</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'models/profiles/gazebo/base'</span>
<span class="nb">require</span> <span class="s1">'models/compositions/arm_cartesian_constant_control_wdls'</span>
<span class="nb">require</span> <span class="s1">'models/compositions/joint_position_constant_control'</span>

<span class="k">module</span> <span class="nn">SyskitBasics</span>
  <span class="k">module</span> <span class="nn">Profiles</span>
    <span class="k">module</span> <span class="nn">Gazebo</span>
      <span class="n">profile</span> <span class="s1">'ArmControl'</span> <span class="k">do</span>
        <span class="n">define</span> <span class="s1">'arm_cartesian_constant_control'</span><span class="p">,</span>
          <span class="no">Compositions</span><span class="o">::</span><span class="no">ArmCartesianConstantControlWdls</span><span class="p">.</span>
            <span class="nf">use</span><span class="p">(</span><span class="no">Base</span><span class="p">.</span><span class="nf">ur10_fixed_dev</span><span class="p">)</span>
        <span class="n">define</span> <span class="s1">'arm_joint_position_constant_control'</span><span class="p">,</span>
          <span class="no">Compositions</span><span class="o">::</span><span class="no">JointPositionConstantControl</span><span class="p">.</span>
            <span class="nf">use</span><span class="p">(</span><span class="no">Base</span><span class="p">.</span><span class="nf">ur10_fixed_dev</span><span class="p">)</span>
        <span class="n">define</span> <span class="s1">'arm_safe_position'</span><span class="p">,</span>
          <span class="n">arm_joint_position_constant_control_def</span><span class="p">.</span>
            <span class="nf">with_arguments</span><span class="p">(</span><span class="ss">setpoint: </span><span class="no">UR10_SAFE_POSITION</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>As we mentioned <a href="constant_generator.html#joint_position_constant_generator">when we defined it</a>,
the joint position constant control has been defined with the goal of providing a sane default
position. Let's make sure this is available easily by creating a definition with a default
setpoint. This will reuse the <code>arm_joint_position_constant_control</code> definition, which is accessed
with the <code>_def</code> suffix. Usable joint positions can be found using the <code>rock-transformer</code> tool:</p>

<div class="highlight"><pre class="highlight plaintext"><code>$ rock-transformer models/sdf/ur10_fixed/model.sdf
</code></pre></div>
<div class="highlight"><pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'models/profiles/gazebo/base'</span>
<span class="nb">require</span> <span class="s1">'models/compositions/arm_cartesian_constant_control_wdls'</span>
<span class="nb">require</span> <span class="s1">'models/compositions/joint_position_constant_control'</span>

<span class="k">module</span> <span class="nn">SyskitBasics</span>
  <span class="k">module</span> <span class="nn">Profiles</span>
    <span class="k">module</span> <span class="nn">Gazebo</span>
      <span class="no">UR10_SAFE_POSITION</span> <span class="o">=</span> <span class="no">Hash</span><span class="p">[</span>
        <span class="s1">'ur10_fixed::ur10::shoulder_pan'</span>  <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">'ur10_fixed::ur10::shoulder_lift'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="no">Math</span><span class="o">::</span><span class="no">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
        <span class="s1">'ur10_fixed::ur10::elbow'</span>         <span class="o">=&gt;</span> <span class="no">Math</span><span class="o">::</span><span class="no">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
        <span class="s1">'ur10_fixed::ur10::wrist_1'</span>       <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">'ur10_fixed::ur10::wrist_2'</span>       <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">'ur10_fixed::ur10::wrist_3'</span>       <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">]</span>

      <span class="n">profile</span> <span class="s1">'ArmControl'</span> <span class="k">do</span>
        <span class="n">define</span> <span class="s1">'arm_cartesian_constant_control'</span><span class="p">,</span>
          <span class="no">Compositions</span><span class="o">::</span><span class="no">ArmCartesianConstantControlWdls</span><span class="p">.</span>
            <span class="nf">use</span><span class="p">(</span><span class="no">Base</span><span class="p">.</span><span class="nf">ur10_fixed_dev</span><span class="p">)</span>
        <span class="n">define</span> <span class="s1">'arm_joint_position_constant_control'</span><span class="p">,</span>
          <span class="no">Compositions</span><span class="o">::</span><span class="no">JointPositionConstantControl</span><span class="p">.</span>
            <span class="nf">use</span><span class="p">(</span><span class="no">Base</span><span class="p">.</span><span class="nf">ur10_fixed_dev</span><span class="p">)</span>
        <span class="n">define</span> <span class="s1">'arm_safe_position'</span><span class="p">,</span>
          <span class="n">arm_joint_position_constant_control_def</span><span class="p">.</span>
            <span class="nf">with_arguments</span><span class="p">(</span><span class="ss">setpoint: </span><span class="no">UR10_SAFE_POSITION</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p class="callout callout-info">A device model is accessed using the device's name with a <code>_dev</code> suffix on the
profile it is defined. Here <code>Base.ur10_fixed_dev</code> is the <code>ur10_fixed</code> device
defined on the robot definition in <code>Base</code>.</p>

<p class="callout callout-info"><strong>Note</strong> when building profiles, the require lines as well as the names of
models and roles that can be used in the <code>use</code> statement can easily be browsed
using the IDE</p>

<p>Let's have a look at the final definition.</p>

<p><img src="media/injected_arm_control_network.png" alt="Final injected arm control network" class="fullwidth" /></p>

<p>We're almost there, just need now to map the components to actual processes, <a href="deployment.html" class="btn btn-primary">a.k.a. deploy the network</a></p>

            </div>
        </div>
    </div>

    <script>
    $('.docs-sidebar').affix({
        offset: {
            top: $('.docs-sidebar').offset().top
        }
    });
    </script>


        <footer class="container-fluid text-center">
        </footer>
    </body>
</html>
